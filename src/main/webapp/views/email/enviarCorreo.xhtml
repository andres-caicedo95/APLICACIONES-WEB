<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="./../newTemplate.xhtml">

    <ui:define name="title">Env√≠o de Correos Masivos</ui:define>

    <ui:define name="content">

        <div class="container mt-4">

            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h2 class="h4 mb-0">
                        <i class="bi bi-envelope-paper"></i>
                        Env√≠o de Correos Masivos
                    </h2>
                    <p class="mb-0 small text-light">
                        Complete la informaci√≥n para enviar correos a m√∫ltiples destinatarios
                    </p>
                </div>

                <div class="card-body">

                    <h:form id="formEmail" styleClass="needs-validation">

                        <h:messages globalOnly="true"
                                    infoStyle="color: #28a745; font-weight: bold; margin-bottom: 1rem; display: block;"
                                    errorStyle="color: #dc3545; font-weight: bold; margin-bottom: 1rem; display: block;"
                                    layout="block"/>

                        <!-- Asunto -->
                        <div class="mb-3">
                            <h:outputLabel for="asunto" value="Asunto *" styleClass="form-label"/>
                            <h:inputText id="asunto" value="#{emailController.asunto}"
                                         required="true" requiredMessage="El asunto es obligatorio"
                                         styleClass="form-control"/>
                            <h:message for="asunto" styleClass="text-danger small"/>
                        </div>

                        <!-- Tipo destinatario -->
                        <div class="mb-3">
                            <h:outputLabel value="Tipo de Destinatario *" for="tipoDestinatario" styleClass="form-label"/>
                            <h:selectOneMenu id="tipoDestinatario"
                                             value="#{emailController.tipoDestinatario}"
                                             required="true"
                                             requiredMessage="Seleccione el tipo de destinatario"
                                             styleClass="form-select"
                                             onchange="this.form.submit()">

                                <f:selectItem itemValue="" itemLabel="Seleccione..."/>
                                <f:selectItems value="#{emailController.tiposDestinatario}"/>
                            </h:selectOneMenu>
                            <h:message for="tipoDestinatario" styleClass="text-danger small"/>
                        </div>

                        <!-- Personalizados -->
                        <h:panelGroup rendered="#{emailController.tipoDestinatario == 'personalizado'}">
                            <div class="mb-3">
                                <h:outputLabel value="Destinatarios Personalizados" styleClass="form-label"/>
                                <p class="text-muted small" style="margin-top:-5px;">
                                    Ingrese correos separados por comas (ej: ejemplo1@gmail.com, ejemplo2@gmail.com)
                                </p>
                                <h:inputTextarea rows="4" styleClass="form-control"
                                                 value="#{emailController.destinatariosPersonalizadosString}"/>
                            </div>
                        </h:panelGroup>

                        <!-- Vista previa -->
                        <h:panelGroup
                                rendered="#{emailController.tipoDestinatario != null 
                                            and emailController.tipoDestinatario != '' 
                                            and emailController.tipoDestinatario != 'personalizado'}">

                            <div class="mb-3">
                                <h:outputLabel value="Destinatarios Seleccionados" styleClass="form-label"/>

                                <div class="p-3 rounded bg-light border d-flex flex-wrap gap-2">

                                    <ui:repeat value="#{emailController.destinatariosPreview}" var="email">
                                        <span class="badge bg-primary px-3 py-2">
                                            #{email}
                                        </span>
                                    </ui:repeat>

                                    <h:outputText value="No se encontraron destinatarios"
                                                  rendered="#{empty emailController.destinatariosPreview}"
                                                  style="color:#718096;"/>
                                </div>
                            </div>
                        </h:panelGroup>

                        <!-- HTML checkbox -->
                        <div class="mb-3 form-check">
                            <h:selectBooleanCheckbox id="htmlCheckbox"
                                                     value="#{emailController.enviarHtml}"
                                                     styleClass="form-check-input"/>
                            <label class="form-check-label" for="htmlCheckbox">
                                Enviar como HTML (permite formato enriquecido)
                            </label>
                        </div>

                        <!-- Cuerpo -->
                        <div class="mb-3">
                            <h:outputLabel for="cuerpo" value="Cuerpo del Correo *" styleClass="form-label"/>
                            <h:inputTextarea id="cuerpo"
                                             value="#{emailController.cuerpo}"
                                             styleClass="form-control"
                                             rows="10"
                                             required="true"
                                             requiredMessage="El cuerpo del correo es obligatorio"/>
                            <h:message for="cuerpo" styleClass="text-danger small"/>
                        </div>

                        <!-- BOTONES -->
                        <div class="d-flex justify-content-end gap-2">
                            <h:commandButton value="üì§ Enviar Correos Masivos"
                                             action="#{emailController.enviarCorreoMasivo}"
                                             styleClass="btn btn-primary"
                                             onclick="return confirm('¬øEst√° seguro de enviar este correo a los destinatarios?');"/>

                            <h:button value="Cancelar"
                                      outcome="/views/dashboard/dashboard"
                                      styleClass="btn btn-secondary"/>
                        </div>

                    </h:form>

                </div>
            </div>

        </div>

    </ui:define>

</ui:composition>
